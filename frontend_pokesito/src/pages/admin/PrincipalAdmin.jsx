import { Link } from 'react-router-dom'
import { useAuth } from '../../hooks/useAuth'
import { usuarioService } from '../../services/usuarioService'
import { useState, useEffect } from 'react'
import '../../styles/PrincipalAdmin.css'

function PrincipalAdmin() {
  const { user, logout } = useAuth()
  const [isMenuOpen, setIsMenuOpen] = useState(false)
  
  // Estados para la gesti√≥n de usuarios
  const [usuarios, setUsuarios] = useState([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState('')
  const [searchTerm, setSearchTerm] = useState('')

  // Cargar usuarios al montar el componente
  useEffect(() => {
    loadUsuarios()
  }, []) // eslint-disable-line react-hooks/exhaustive-deps

  const loadUsuarios = async () => {
    try {
      setLoading(true)
      setError('')
      
      // Debug info
      console.log('üîç PrincipalAdmin - Cargando usuarios...')
      console.log('Token:', localStorage.getItem('token'))
      console.log('Usuario actual:', user)
      
      const response = await usuarioService.getAllUsuarios()
      console.log('‚úÖ PrincipalAdmin - Respuesta de usuarios:', response)
      console.log('‚úÖ PrincipalAdmin - response.data:', response.data)
      console.log('‚úÖ PrincipalAdmin - Tipo de response.data:', typeof response.data)
      console.log('‚úÖ PrincipalAdmin - Es array response.data:', Array.isArray(response.data))
      
      if (response.success) {
        // Verificar si response.data es un array o si est√° dentro de una propiedad
        let usuariosData = response.data;
        
        // Si response.data no es un array, buscar el array en propiedades comunes
        if (!Array.isArray(usuariosData)) {
          console.log('‚ùì response.data no es array, buscando usuarios en propiedades...')
          usuariosData = response.data.usuarios || 
                        response.data.datos || 
                        response.data.data || 
                        response.data.users || 
                        [];
          console.log('‚úÖ Usuarios encontrados en:', usuariosData)
        }
        
        // Asegurar que sea un array
        const finalUsuarios = Array.isArray(usuariosData) ? usuariosData : [];
        setUsuarios(finalUsuarios)
        console.log('‚úÖ Usuarios finales cargados:', finalUsuarios.length, finalUsuarios)
      } else {
        setError(response.message || 'Error al cargar usuarios')
        console.error('‚ùå Error en la respuesta:', response.message)
      }
    } catch (error) {
      console.error('‚ùå Error al cargar usuarios:', error)
      setError('Error al cargar usuarios: ' + error.message)
    } finally {
      setLoading(false)
    }
  }

  // Funci√≥n para probar la conexi√≥n con el API
  const testApiConnection = async () => {
    try {
      console.log('üîç Probando conexi√≥n con API...')
      const token = localStorage.getItem('token')
      
      if (!token) {
        alert('‚ùå No hay token de autenticaci√≥n')
        return
      }
      
      console.log('Token presente:', token.substring(0, 20) + '...')
      
      const response = await usuarioService.getAllUsuarios()
      
      if (response.success) {
        alert(`‚úÖ Conexi√≥n exitosa! Se encontraron ${response.data?.length || 0} usuarios`)
      } else {
        alert(`‚ùå Error: ${response.message}`)
      }
    } catch (error) {
      console.error('Error de conexi√≥n:', error)
      alert(`‚ùå Error de conexi√≥n: ${error.message}`)
    }
  }

  // Funci√≥n para probar el endpoint de actualizaci√≥n de usuario
  const testUpdateEndpoint = async () => {
    try {
      if (usuarios.length === 0) {
        alert('‚ùå No hay usuarios cargados para probar')
        return
      }

      // Tomar el primer usuario que no sea el actual
      const testUser = usuarios.find(u => 
        (u.id || u.id_usuario) !== (user.id || user.id_usuario)
      )

      if (!testUser) {
        alert('‚ùå No hay otros usuarios para probar')
        return
      }

      const userId = testUser.id || testUser.id_usuario
      const currentAdmin = testUser.admin || testUser.es_admin || false

      console.log(`üîç Probando endpoint PUT /usuarios/${userId}`)
      console.log(`üîç Usuario de prueba:`, testUser)
      console.log(`üîç Estado admin actual: ${currentAdmin}`)

      // Probar cambio de admin sin realmente cambiar (doble toggle)
      const response1 = await usuarioService.toggleAdminPermission(userId, !currentAdmin)
      
      if (response1.success) {
        console.log('‚úÖ Primera prueba exitosa')
        
        // Volver al estado original
        const response2 = await usuarioService.toggleAdminPermission(userId, currentAdmin)
        
        if (response2.success) {
          alert('‚úÖ Endpoint PUT /usuarios/:id funciona correctamente!')
        } else {
          alert('‚ö†Ô∏è Primera prueba exitosa, segunda fall√≥: ' + response2.message)
        }
      } else {
        alert('‚ùå Error en endpoint: ' + response1.message)
      }
    } catch (error) {
      console.error('Error de prueba:', error)
      alert(`‚ùå Error en prueba: ${error.message}`)
    }
  }

  const handleLogout = () => {
    logout()
  }

  const toggleMenu = () => {
    setIsMenuOpen(!isMenuOpen)
  }

  const closeMenu = () => {
    setIsMenuOpen(false)
  }

  const handleToggleAdmin = async (userId, currentAdminStatus) => {
    if (userId === user.id || userId === user.id_usuario) {
      alert('No puedes cambiar tus propios permisos de administrador')
      return
    }

    try {
      console.log(`üîç Cambiando permisos de admin para usuario ${userId}`)
      console.log(`üîç Estado actual: ${currentAdminStatus}, nuevo estado: ${!currentAdminStatus}`)
      
      const response = await usuarioService.toggleAdminPermission(userId, !currentAdminStatus)
      
      if (response.success) {
        alert('‚úÖ ' + (response.message || 'Permisos actualizados exitosamente'))
        console.log('‚úÖ Permisos cambiados exitosamente')
        
        // Actualizar solo el usuario espec√≠fico en lugar de recargar toda la lista
        setUsuarios(prevUsuarios => 
          prevUsuarios.map(usuario => 
            (usuario.id || usuario.id_usuario) === userId 
              ? { ...usuario, admin: !currentAdminStatus, es_admin: !currentAdminStatus }
              : usuario
          )
        )
      } else {
        alert('‚ùå Error: ' + response.message)
        console.error('‚ùå Error al cambiar permisos:', response.message)
      }
    } catch (error) {
      alert('‚ùå Error al cambiar permisos')
      console.error('‚ùå Error toggling admin permission:', error)
    }
  }

  const handleDeleteUser = async (userId) => {
    if (userId === user.id || userId === user.id_usuario) {
      alert('No puedes eliminar tu propia cuenta')
      return
    }

    if (window.confirm('¬øEst√°s seguro de que deseas eliminar este usuario?')) {
      try {
        console.log(`üîç Eliminando usuario ${userId}`)
        
        const response = await usuarioService.deleteUsuario(userId)
        
        if (response.success) {
          alert('‚úÖ Usuario eliminado exitosamente')
          console.log('‚úÖ Usuario eliminado exitosamente')
          
          // Remover el usuario de la lista local
          setUsuarios(prevUsuarios => 
            prevUsuarios.filter(usuario => 
              (usuario.id || usuario.id_usuario) !== userId
            )
          )
        } else {
          alert('‚ùå Error: ' + response.message)
          console.error('‚ùå Error al eliminar usuario:', response.message)
        }
      } catch (error) {
        alert('‚ùå Error al eliminar usuario')
        console.error('‚ùå Error deleting user:', error)
      }
    }
  }

  // Filtrar usuarios por b√∫squeda
  const filteredUsuarios = Array.isArray(usuarios) ? usuarios.filter(usuario =>
    (usuario.nombre || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
    (usuario.apellido || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
    (usuario.email || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
    (usuario.correo || '').toLowerCase().includes(searchTerm.toLowerCase())
  ) : []

  // El componente ProtectedRoute ya maneja la autenticaci√≥n y autorizaci√≥n
  if (!user) {
    return (
      <div className="loading-container">
        <div className="loading-spinner"></div>
        <p>Cargando...</p>
      </div>
    )
  }

  if (loading) {
    return (
      <div className="loading-container">
        <div className="loading-spinner"></div>
        <p>Cargando usuarios...</p>
      </div>
    )
  }

  return (
    <div className="dashboard-container">
      <header className="dashboard-header">
        <div className="header-left">
          <button className="hamburger-menu" onClick={toggleMenu}>
            <span className="hamburger-line"></span>
            <span className="hamburger-line"></span>
            <span className="hamburger-line"></span>
          </button>
          <h1>üîß Panel de Administraci√≥n</h1>
        </div>
        <div className="header-right">
          <span className="admin-info">Admin: {user.nombre} {user.apellido}</span>
          <Link to="/client" className="back-btn">
            Volver al Cliente
          </Link>
          <button onClick={handleLogout} className="logout-btn">
            Cerrar Sesi√≥n
          </button>
        </div>
      </header>
      
      {/* Overlay para cerrar el men√∫ */}
      {isMenuOpen && <div className="menu-overlay" onClick={closeMenu}></div>}
      
      {/* Men√∫ lateral */}
      <nav className={`sidebar-menu ${isMenuOpen ? 'menu-open' : ''}`}>
        <div className="menu-header">
          <h3>Men√∫ de Administraci√≥n</h3>
          <button className="close-menu" onClick={closeMenu}>√ó</button>
        </div>
        <ul className="menu-list">
          <li>
            <Link to="/admin/users" className="menu-item" onClick={closeMenu}>
              <span className="menu-icon">üë•</span>
              <span className="menu-text">Gestionar Usuarios</span>
            </Link>
          </li>
          <li>
            <Link to="/admin/tipos" className="menu-item" onClick={closeMenu}>
              <span className="menu-icon">üè∑Ô∏è</span>
              <span className="menu-text">Gestionar Tipos</span>
            </Link>
          </li>
          <li>
            <Link to="/admin/categorias" className="menu-item" onClick={closeMenu}>
              <span className="menu-icon">üìÇ</span>
              <span className="menu-text">Gestionar Categor√≠as</span>
            </Link>
          </li>
          <li>
            <Link to="/admin/movimientos" className="menu-item" onClick={closeMenu}>
              <span className="menu-icon">‚ö°</span>
              <span className="menu-text">Gestionar Movimientos</span>
            </Link>
          </li>
          <li>
            <Link to="/admin/articulos" className="menu-item" onClick={closeMenu}>
              <span className="menu-icon">üéØ</span>
              <span className="menu-text">Gestionar Art√≠culos</span>
            </Link>
          </li>
          <li>
            <Link to="/admin/habilidades" className="menu-item" onClick={closeMenu}>
              <span className="menu-icon">‚ú®</span>
              <span className="menu-text">Gestionar Habilidades</span>
            </Link>
          </li>
          <li>
            <Link to="/admin/pokemons" className="menu-item" onClick={closeMenu}>
              <span className="menu-icon">üéÆ</span>
              <span className="menu-text">Gestionar Pok√©mon</span>
            </Link>
          </li>
        </ul>
      </nav>
      
      <main className="dashboard-content">
        <div className="usuarios-section">
          <div className="usuarios-header">
            <h2>üë• Gesti√≥n de Usuarios</h2>
            <p>Administra usuarios, permisos y configuraciones del sistema</p>
          </div>

          <div className="usuarios-controls">
            <div className="search-container">
              <input
                type="text"
                placeholder="Buscar usuarios..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                className="search-input"
              />
            </div>
            <div className="admin-actions">
              <button
                onClick={testApiConnection}
                className="test-api-btn"
                style={{
                  backgroundColor: '#9b59b6',
                  color: 'white',
                  border: 'none',
                  padding: '0.75rem 1rem',
                  borderRadius: '8px',
                  fontSize: '0.9rem',
                  cursor: 'pointer',
                  marginRight: '0.5rem'
                }}
              >
                üîç Probar API
              </button>
              <button
                onClick={testUpdateEndpoint}
                className="test-update-btn"
                style={{
                  backgroundColor: '#e67e22',
                  color: 'white',
                  border: 'none',
                  padding: '0.75rem 1rem',
                  borderRadius: '8px',
                  fontSize: '0.9rem',
                  cursor: 'pointer',
                  marginRight: '0.5rem'
                }}
              >
                üîß Probar PUT
              </button>
              <button
                onClick={loadUsuarios}
                className="refresh-btn"
                disabled={loading}
              >
                üîÑ Actualizar Lista
              </button>
              <Link to="/admin/users" className="manage-users-btn">
                ‚öôÔ∏è Gesti√≥n Completa
              </Link>
            </div>
          </div>

          {error && <div className="error-message">{error}</div>}

          <div className="usuarios-grid">
            {filteredUsuarios.length === 0 ? (
              <div className="no-users">
                <p>No se encontraron usuarios</p>
              </div>
            ) : (
              filteredUsuarios.map(usuario => (
                <div key={usuario.id || usuario.id_usuario} className="usuario-card">
                  <div className="usuario-header">
                    <h3>{usuario.nombre || 'Sin nombre'} {usuario.apellido || ''}</h3>
                    {(usuario.es_admin || usuario.admin) && (
                      <span className="admin-badge">ADMIN</span>
                    )}
                  </div>
                  
                  <div className="usuario-info">
                    <p><strong>Email:</strong> {usuario.email || usuario.correo || 'Sin email'}</p>
                    <p><strong>ID:</strong> {usuario.id || usuario.id_usuario || 'Sin ID'}</p>
                    <p><strong>Registrado:</strong> {
                      usuario.created_at 
                        ? new Date(usuario.created_at).toLocaleDateString() 
                        : usuario.fecha_registro 
                        ? new Date(usuario.fecha_registro).toLocaleDateString()
                        : 'Fecha no disponible'
                    }</p>
                  </div>

                  <div className="usuario-actions">
                    <button
                      onClick={() => handleToggleAdmin(
                        usuario.id || usuario.id_usuario, 
                        usuario.es_admin || usuario.admin
                      )}
                      className={`toggle-admin-btn ${
                        (usuario.es_admin || usuario.admin) ? 'remove-admin' : 'make-admin'
                      }`}
                      disabled={
                        (usuario.id || usuario.id_usuario) === (user.id || user.id_usuario)
                      }
                    >
                      {(usuario.es_admin || usuario.admin) ? 'Quitar Admin' : 'Hacer Admin'}
                    </button>
                    
                    <button
                      onClick={() => handleDeleteUser(usuario.id || usuario.id_usuario)}
                      className="delete-user-btn"
                      disabled={
                        (usuario.id || usuario.id_usuario) === (user.id || user.id_usuario)
                      }
                    >
                      üóëÔ∏è Eliminar
                    </button>
                  </div>
                </div>
              ))
            )}
          </div>

        </div>
      </main>
    </div>
  )
}

export default PrincipalAdmin